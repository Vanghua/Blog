# 高性能可编辑表格

## 1.摘要

​	可编辑表格是一种复杂的数据处理控件。它集成了单元格编辑，校验，联动，全键盘等功能，并主要应用于勤策的消费行业模块，例如TPM和MERP。而数据是可编辑表格首要的关注对象，从数据的角度来看，即使当今各种竞品的ERP系统的数据分析方式层出不穷，但是基于表格的数据展示，数据分析和数据处理是ERP系统长久以来的核心功能之一，也是客户衡量ERP系统优劣的重要标准之一。

​	ERP系统在经历了几十年的发展之后，已经被广泛应用于国内的诸多企业。在下一个十年中，ERP厂商间的角逐将会愈发激烈。为了满足客户对于大数据量下能够流畅编辑表格的需求，以及能保证勤策的MERP，TPM等系统能在激烈的竞争中取得优势，因此我们在可编辑表格的性能方面基于Antd4和React框架进行了创新性的研究和更贴合于业务的优化。

​	勤策当前的可编辑表格只能支持大约1000到2000个单元格（即100余行，10余列）的流畅编辑。而我们的研究目标是使具有30万个单元格的可编辑表格的数据处理和数据分析过程在不分页的情况下可以流畅进行。研究方向聚焦于海量数据校验，虚拟列表滚动无白屏闪动，虚拟列表接入可编辑表格等内容。研究提出了前端集成线程池优化高密度计算，仅通过修改DOM结构优化虚拟列表滚动，虚拟列表接入业务自定义表格等方法。这些解决方法具有较高创新性，并且主流技术社区，主流框架均未曾涉及。目前我们的高性能可编辑表格的研究已经在部分模块中进行了试点，并且获得了预期效果。



## 2.介绍

​	我们对于可编辑表格的创新优化分为性能优化和业务使用体验优化。下面将会根据可编辑表格的功能进行逐一介绍。

### 2.1 编辑

​	可编辑表格的编辑指的是：“点击单元格进入编辑模式，在不同的编辑模式下（例如下拉表格，下拉选择框和文本框等）修改单元格的值，并在编辑过程中触发校验，联动，全键盘等操作”。编辑功能是可编辑表格的基础功能，从编辑功能延伸出了校验，联动，全键盘等功能。目前可编辑表格的所有功能几乎均源于编辑，而当前的可编辑表格控件在处理这些扩展开的功能时并没有很好的做抽象处理，把一些公共的逻辑暴露给了业务处理。我们在新的高性能可编辑表格中对表格的模型进行了更深入的抽象，给业务方提供了“傻瓜”式调用接口，相较之前版本，在使用体验上得到了进步。

![](./assets/编辑.PNG)

<font size=2>图（1）可编辑表格编辑功能举例</font>

### 2.2 校验

​	可编辑表格的校验指的是：“判断表格中的单元格是否符合业务定义的规则”。校验功能通常被应用于“用户提交表格数据之前”，“用户导入表格数据之后”，“用户编辑单元格数据之后”。在普通的业务场景下，单元格的校验既可以委托给前端处理，也可以委托给后端处理，它并不存在任何的复杂逻辑和性能负担。但是目前在海量数据的场景下，前端和后端对单元格校验都受到不同程度的约束。我们在处理海量单元格校验时综合考量了前后端处理的特点，实现了基于线程池的前端校验方式，使前端就可以轻松解决该问题。

![](./assets/校验.PNG)

<font size=2>图（2）可编辑表格校验功能举例</font>

### 2.3 联动

​	联动功能是可编辑表格编辑功能的延伸。联动指的是：“表格内部单元格的变化影响到其它单元格或表格外部元素，导致它们的值或样式发生变化”。在业务中联动是复杂的场景，可以大致分为：（1）可编辑单元格和可编辑单元格间联动（2）可编辑单元格和不可编辑单元格间联动（3）可编辑单元格和可编辑表格外部联动（4）可编辑单元格和未渲染的行数据和可编辑单元格间联动（5）可编辑单元格不依赖表单和可编辑单元格联动等等。在可编辑表格中实现联动需要集成多种复杂场景，并在业务端做不少操作，本次研究中简化了联动的使用方式，减轻了业务端使用的压力。

### 2.4 全键盘

​	全键盘功能是可编辑表格编辑功能的延伸。全键盘指的是：“在不依赖于鼠标的情况下完成表格的编辑，包括选择，保存，换行，滚动等功能”。全键盘在老版本可编辑表格的实现和使用上都较为繁琐，和表格控件子功能以及业务代码都紧密耦合，例如单元格的聚焦，失焦等功能需要交付业务手动设置。在本次研究中优化了全键盘的实现，创新地以钩子的形式在可编辑表格入口直接注入，和可编辑表格的单元格函数，行函数进行了解耦。在业务侧实现了自动失焦，聚焦，避免了业务侧关注全键盘内部的处理逻辑。把整个全键盘功能抽象成一个子模块处理。



## 3.创新实现

### 3.1 编辑

​	勤策前端目前使用的是React和Antd4框架。这两个框架虽然在诸多业务场景中展现了卓越的优势，但是它们在实现高性能可编辑表格上具有一定的限制，因此会对可编辑表格处理海量数据造成不同程度的性能瓶颈。

#### 3.1.1 瓶颈分析

* **海量数据下表格编辑功能无法使用：** 海量数据场景下页面的渲染负担会变得非常沉重，原因是计算机没有足够的内存用来处理无穷无尽的数据。在这种场景下常见的做法是对数据分页，或使用“虚拟列表（Virtual List）”技术，这两种技术均是对数据进行分片处理，把大数据切成计算机可以处理的片段后再交付浏览器处理。但是目前主流的框架和技术社区均没有可编辑表格接入虚拟列表的案例，推荐的方案均为对海量数据进行分页处理。这样处理的原因是虚拟列表的实现会占用Antd4表格的自定义单元格和行的功能，但是可编辑表格的核心代码几乎全部需要占用Antd4表格的自定义单元格和行的功能。这在设计上产生了直接冲突，目前的可编辑表格控件中无法“开箱即用”式直接接入虚拟列表。

* **虚拟列表滑动过快时会产生短暂白屏：** 在Antd4框架中没有用于处理海量数据展示的控件，而官方只是推荐了少数几个较为贴合Antd4框架的海量数据展示库。这些库均使用了“虚拟列表”技术对海量数据的展示进行优化。虚拟列表技术是指：“在页面上只展示海量数据的一部分，用户拖动滚动条时再通过动态加载和卸载的技术来计算下一步要展示的部分数据。以减少展示的数据量来减少浏览器对海量数据的渲染压力”。但是这些库中的虚拟列表均是采用长列表滚动后再将展示的部分数据推入浏览器视口的做法，这样的做法会导致快速滚动时虚拟列表区域短暂白屏。白屏的原因是浏览器的合成线程处理滚动事件时不会等待主线程中的事件处理器，这就导致我们在滚动时，数据的出现时机总是比我们的滚动时机慢半拍，从而导致短暂白屏。

#### 3.1.2 虚拟列表接入可编辑表格

​	由于目前Antd4官方推荐的虚拟列表库无法直接接入可编辑表格，因此直接堵死了可编辑表格处理海量数据最核心的步骤。在查阅了这些虚拟列表库后，发现了其中某些库具有短小精悍，可扩展性强的特点，并且使用了MIT开源协议。因此我们在研究时选择了VirtualList-antd库，在此基础上对它的自定义单元格函数和行函数做了扩展。最终支持了在虚拟列表已经自定义了表格的单元格和行后，我们的可编辑表格控件再在其基础上做第二层自定义操作，解决了可编辑表格无法直接接入虚拟列表技术的问题。

#### 3.1.3 虚拟列表白屏优化

* **大容量缓冲区：** 目前主流技术社区对虚拟列表白屏优化的关注并不多，最多的解决方案是在保持原有设计方案的同时为列表上下留出足够的缓冲区，在可视区域外额外装填一部分数据。该方案只能保证虚拟列表在正常速率滚动时不出现白屏，一旦滚动速率上升，在单位时间内的滚动数据量超出了缓冲区数据量，那么仍然会出现白屏的问题。

* **模拟滚动条：** 有少部分框架为了解决该问题放弃了浏览器默认滚动条的使用，例如最近刚刚推出的Antd5框架中的虚拟列表。因为浏览器合成线程（Compositor Thread）不会等待主线程对滚动事件做出响应，所以浏览器默认的滚动行为从本质上就无法解决该问题。因此这些框架中使用了自己模拟的滚动条来代替浏览器的滚动条，这使得滚动条是否滚动完全由主线程中的事件处理器控制，这样就可以保证滚动和对滚动的响应能几乎同步进行。这种解决方案很好的解决了虚拟列表白屏问题，但是缺点是模拟的滚动条并不能百分百还原浏览器滚动条的能力。
* **固定可视区域：** 在本次研究中结合了上述两种方案的特点，提出了暂时在主流技术社区上从未出现过的方法。为了保留浏览器滚动条的原生能力，我们在研究时采取了和第一种方法一样的传统虚拟列表设计结构。研究从瓶颈点入手，瓶颈是计算和渲染下一步展示的数据必然会晚于滚动条的滚动，从而导致页面会先滚动到了长列表的空白区域。既然如此，我们放弃了计算了滚动时下一步展示数据的位置，直接把数据展示容器固定到虚拟列表的展示区域。在固定过程中需要调整DOM结构即可。这种方式受限于DOM结构该如何调整才能满足容器恰好固定并覆盖到虚拟列表的展示区域，并且还要为浏览器的滚动条留出空间。不过勤策前端在虚拟列表的目前仅集中于表格控件，因此该方法相较前两种是效果更好，改动更小的方案。

![](./assets/虚拟列表.PNG)

<font size=2>图（3）虚拟列表举例</font>

#### 3.1.4 实现成果

​	目前在使用了上述的优化方案后，可编辑表格在处理海量数据的编辑功能时和处理普通数据的编辑完全没有区别。

### 3.2 校验

#### 3.2.1 瓶颈分析

​	在海量数据场景下，使用基于React和Antd4提供的表单控件进行校验会导致极大的性能负担。导致性能负担的原因有多个，可以归纳为Antd4提供的表单校验能力差，前端单线程无法快速处理海量数据校验，传输海量数据给后端校验会导致请求传输速度变慢和增加服务器的性能压力。

* **Antd4校验能力瓶颈：** Antd4表单校验能力差可以追溯到为Antd4提供基础能力支撑的React-Component框架（简称RC）。在RC中如果想使用表单的校验能力，那么必须将所有单元格包裹到RC表单的表单项中。这就意味着为了使用校验功能我们不得不把所有单元格进行包裹，并额外维护RC表单项中的所有逻辑。
* **前端单线程瓶颈：** 前端单线程无法快速处理海量数据指的是前端只有一个主线程在维护前端逻辑和浏览器渲染，并且不论我们将任务转化成同步还是异步，对海量数据进行逻辑处理会直接阻塞浏览器对页面每帧的渲染，在严重情况下会直接卡死页面。
* **后端校验瓶颈：** 传输30万个单元格的数据给后端并委托给后端校验需要考虑两个问题。一是在网络通信过程中传输海量数据会影响通信质量，需要考虑海量数据对于通信信道的阻塞状况，以及数据量的上升会导致更多的丢包和重传状况。二是海量数据校验会造成服务器的性能负担，需要考虑是否要在某些服务器上新启用服务或扩展新的微服务节点，会使整体的部署结构变得复杂。

#### 3.2.2 线程池优化

​	结合上述三点考虑，我们在研究过程中抛弃了Antd4提供的表单校验能力，放弃了将海量单元格交付后端校验。最后在考虑前端单线程瓶颈时，决定使用线程池技术来处理海量数据校验的优化。前端的多线程能力已经应用于多个方向，例如服务线程用于缓存和更贴近原生的优化，共享线程用于跨窗口通信，工作线程用于简单的辅助计算。在百度地图，高德地图，Echarts，AntdV等绘图第三方库中辅助线程已经得到了运用，但是运用仅仅局限于单页面中简单启动一到两个辅助线程做一些为数不多的辅助运算。并且在主流前端社区中，例如github，谷歌开发者社区等几乎没有库或框架支持前端的线程池调度，只有为数不多的库仅仅对多线程的使用上进行了简化处理，而这些处理对于我们的研究需求没有任何帮助。我们在研究过程中创新地使用了线程池，并封装了可调用的线程池类用于计算密集型场景的优化。考虑到不同用户的计算机性能问题，我们在调度线程时结合了CPU核数，JavaScript堆内存使用量等情况合理安排调度算法，并且有意在不牺牲性能的情况下减少线程池容量，避免占用过多内存。

![](./assets/线程池1.PNG)

<font size=2>图（4）前端线程池线程分配功能设计举例</font>

![](./assets/线程池2.PNG)

<font size=2>图（5）前端线程池线程释放功能举例</font>

#### 3.2.2 实现成果

​	在30万个单元格的校验场景下，如果直接使用Antd4提供的表单校验，那么会导致页面直接崩溃，因为在校验前必须向页面中填充所有单元格才能使用其校验能力，而目前的浏览器根本无法承受海量数据的渲染需求。

​	如果抛弃Antd4，使用异步校验来优化校验，结果也是不尽人意，因为过多的异步任务阻塞了前端事件循环的运转，导致浏览器长时间无法满足任何渲染需求。在这种场景下，校验的时间保持在2.7秒上下浮动。

​	如果使用线程池来校验，那么在线程池容量为5个可用线程，并且把待校验数据切片为10份时，校验的时间保持在0.8秒上下浮动。

![](./assets/同步校验.PNG)

<font size=2>图（6）可编辑表格编辑同步校验速度举例</font>

![](./assets/异步校验.PNG)

<font size=2>图（7）可编辑表格异步校验速度举例</font>

## 4.总结与展望

​	目前的可编辑表格在处理海量数据上已经初见成效，但是也有许多可以提升的方面。计划在下一步研究中吸引更多感兴趣的同事加入，贡献更多的想法。下面将围绕上文提到的业务体验优化和性能瓶颈优化做出总结和展望。

* **联动和全键盘：** 联动和全键盘的场景仍有提升的空间，在本次的研究中只是将联动的场景进一步抽象，简化了一些组件接口供业务调用。但是没有考虑业务场景是否可以做简化，能否做一个中间层或中间件处理复杂的联动场景，而业务端和可编辑表格组件端仅通过一到两种简单方式进行联动，这将是下一步研究的方向。全键盘场景未来的研究将集中于性能提升，目前在进行键盘操作时每次都需要查询可视区域所有单元格进行分析，是否可以通过缓存或类似于虚拟DOM的比较方法对查询单元格的频率进行优化，将会是下一步研究的计划。

* **虚拟列表白屏优化：** 虚拟滚动列表的白屏优化方案是一个较为创新的方案，但是由于没有借鉴案例，所以在日常的维护上经常出现某些问题难以解决或解决时间过长的问题。下一步的研究将针对最近几个月刚刚上线的Antd5框架进行调研，探究模拟滚动条和本次提出的方案做进一步的融合，减少模拟滚动条的额外代码，并且能尽可能多的保留浏览器原生滚动条的滚动能力。

* **线程池优化：** 由于前端还没有一个完整的多线程生态，因此在线程池处理上可以考虑做进一步创新性优化。下一步的研究将考虑线程池调度算法的优化，在降低线程池容量时不牺牲并发计算的速度。另一方面是考虑针对海量数据运算的运算架构上做多维度处理，海量数据交付后端计算不是理想的做法，但是如果用户的计算机性能无法支撑一定容量的线程池进行并发运算，那么可以考虑优化数据切片算法，一是过多的数据切片将阻塞线程池调度，二是前端的线程池辅助计算模型无法进行分布式部署。后续的研究将考虑海量数据的切片不只是交付给线程池处理，还可以将部分切片交付后端处理，通过负载均衡分配到任务轻松的服务器做计算。

​	





